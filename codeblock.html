<!DOCTYPE html>
<html lang="ru">
<head>
<link rel="icon" type="image/png" sizes="32x32" href="image_pdf/ss.jpg">
<meta charset="UTF-8">
<!-- Адаптивность  -->
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>НАШ сайт</title>
<link rel="stylesheet" href="css/general.css">
<link rel="stylesheet" href="css/codeblock/codeblock.css">
<link rel="stylesheet" href="css/codeblock/blocks.css">
</head>
<body>
  <div class="card">
    <!-- Кнопки -->
    <a href="codeblock.html" class="contact-buttonn">Главное</a>
    <a href="about_me.html" class="contact-button">О нас</a>
    <a href="gaide.pdf" class="contact-button">Как пользоваться ЭТИМ (Никак)</a>
  </div>


  <input type="checkbox" id="side-checkbox" />

  <div class="side-panel">
    <label class="side-button-2" for="side-checkbox">+</label>
    <div class="block" block_type="event" onclick="to_sz(this)">
      <div class="top_block">
        Event
        <button class="delete-button_x">x</button>
      </div>
      <div class="three_columns">
        <div class="column">
          <button onclick="event(this)">Start</button>
        </div>
        <div class="column">
          Start
        </div>
        <div class="column">
          <button class="out" _type="Exec">></button>
        </div>
      </div>
    </div>

    <div class="block" block_type="variable" onclick="to_sz(this)">
      <div class="top_block">
        Variable
        <button class="delete-button_x">x</button>
      </div>
      <div class="three_columns">
        <div class="column">
        </div>
        <div class="column">
          <!--Здесь выбирается тип данных для переменной-->
          <select>
            <option>Integer</option>
            <option>Float</option>
            <option>String</option>
            <option selected>Boolean</option>
          </select>
          <!--Здесь вводится названия переменным-->
          <input style="width: 30px;" name="Var">
        </div>
        <div class="column">
          <!--Тип данных будет зависеть от входных данных на блоке-->
          <button class="out" _type="Exec">></button>
        </div>
      </div>
    </div>

    <div class="block" block_type="assignment_operation" onclick="to_sz(this)">
      <div class="top_block">
        Set
        <button class="delete-button_x">x</button>
      </div>
      <div class="three_columns">
        <div class="column">
          <button class="in" _type="Exec">></button>
          <!--Будет зависеть от 1-го входа-->
          <button class="in" _type="">></button>
          <button class="in" _type="">></button>
        </div>
        <div class="column">
        </div>
        <div class="column">
          <button class="out" _type="Exec">></button>
        </div>
      </div>

    </div>

    <div class="block" block_type="get" onclick="to_sz(this)">
      <div class="top_block">
        Get
        <button class="delete-button_x">x</button>
      </div>
      <div class="three_columns">
        <div class="column">
        </div>
        <div class="column">
          <input style="width: 30px;" list="choose_or_input">
          <datalist id="choose_or_input">
            <!--Здесь выбираются переменные-->
            <option>A</option>
          </datalist>
        </div>
        <div class="column">
          <button class="out" _type="Exec">></button>
        </div>
      </div>
    </div>

    <div class="block" block_type="sum" onclick="to_sz(this)">
      <div class="top_block">
        sum
        <button class="delete-button_x">x</button>
      </div>
      <div class="three_columns">
        <div class="column">
          <button class="in" _type="Integer">></button>
          +
          <button class="in" _type="Integer">></button>
          <button class="add">+</button>
        </div>
        <div class="column">
          <input style="width: 30px;">
          +
          <input style="width: 30px;">
        </div>
        <div class="column">
          <button class="out" _type="Integer">></button>
        </div>
      </div>
    </div>

    <div class="block" block_type="branch" onclick="to_sz(this)">
      <div class="top_block">
        Branch (if)
        <button class="delete-button_x">x</button>
      </div>
      <div class="three_columns">
        <div class="column">
          <button class="in" _type="Exec">></button>
          <button class="in" _type="Boolean">></button>
        </div>
        <div class="column">
          <br>True</br>
          <br>False</br>
        </div>
        <div class="column">
          <button class="out" _type="Exec">></button>
          <button class="out" _type="Exec">></button>
        </div>
      </div>
    </div>

    <div class="block" block_type="cout" onclick="to_sz(this)">
      <div class="top_block">
        Cout
        <button class="delete-button_x">x</button>
      </div>
      <div class="three_columns">
        <div class="column">
          <button class="in" _type="Exec">></button>
          <button class="in" _type="String">></button>
        </div>
        <div class="column">
        </div>
        <div class="column">
        </div>
      </div>
    </div>

    <div class="block" block_type="const" onclick="to_sz(this)">
      <div class="top_block">
        Const
        <button class="delete-button_x">x</button>
      </div>
      <div class="three_columns">
        <div class="column">
        </div>
        <div class="column">
          <input style="width: 30px;" type="text">
        </div>
        <div class="column">
          <button class="out" type="">></button>
        </div>
      </div>
    </div>
  </div>


  <div class="safe-zone">
    <svg style="position: absolute; height:  100%; width: 100%;"> </svg>
  </div>
  <script src="scripts/block_scripts.js"></script>
  <!--Размещение блоков-->
  <script>
      var safe_zone = document.querySelector(".safe-zone");
      var id_list = [];
      var cur_i = 0;
      var id_cur = [cur_i];

      //Позже доработаю id кнопок
      var but_in_id = 0;
      var but_out_id = 0;

      function to_sz(t){
        let c_t = t.cloneNode(true);
        c_t.removeAttribute("onclick");
        c_t.classList.add("movable");
        safe_zone.append(c_t);

        let out_t = c_t.querySelectorAll(".out")
        if (out_t){
          for (i of out_t){
            i.setAttribute("onclick", "pin_out(this)");
            i.setAttribute("id", "out_" + but_out_id);
            but_out_id += 1;
          }
        }

        let in_t = c_t.querySelectorAll(".in")
        if (in_t){
          for (i of in_t){
            i.setAttribute("onclick", "pin_in(this)");
            i.setAttribute("id", "in_" + but_in_id);
            but_in_id += 1;
          }
        }
        
        let b_t = c_t.querySelector(".delete-button_x")
        b_t.className = "delete-button";
        b_t.setAttribute("onclick", "delete_block(this)");

        c_t.id = id_cur[0];

        if (cur_i == id_cur[0]) {
          id_list.push(id_cur[0]);
          id_cur.pop();
          cur_i += 1;
          id_cur.push(cur_i);
        }
        else{
          id_list.push(id_cur[0]);
          id_cur.shift();
        }

        add_to_blocks(c_t);
      }
  </script>
  <!--Удаление блоков + закрепление ID и + -->
  <script>

      var flag_1 = false;
      var flag_2 = false;
      
      var t_1 = null;
      var t_2 = null;

      function pin_out(t){
        flag_1 = true;
        flag_3 = true;
        t_1 = t;

        i_line = document.createElementNS("http://www.w3.org/2000/svg", "line");

        let svgRect = svg.getBoundingClientRect();
        let outRect = t_1.getBoundingClientRect();
        startX = outRect.left + outRect.width/2 - svgRect.left;
        startY = outRect.top + outRect.height/2 - svgRect.top;

        i_line.setAttribute("x1", startX);
        i_line.setAttribute("y1", startY);
        i_line.setAttribute("x2", startX);
        i_line.setAttribute("y2", startY);
        i_line.setAttribute("stroke-width", 2);
        i_line.setAttribute("stroke", "white");

        svg.append(i_line);

        circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("fill", "white");
        circle.setAttribute("cx", startX);
        circle.setAttribute("cy", startY);
        circle.setAttribute("r", 5);

        svg.append(circle);

        mouse_move = function(e){
          i_line.setAttribute("x2", e.clientX - svgRect.left);
          i_line.setAttribute("y2", e.clientY - svgRect.top);
          circle.setAttribute("cx", e.clientX - svgRect.left)
          circle.setAttribute("cy", e.clientY - svgRect.top)
        };

        mouse_up = function(e){
          let el = e.target.closest(".in");
          if (!el){
            flag_1 = false;
            flag_2 = false;
            console.log(true);
          }

          document.removeEventListener("mousemove", mouse_move);
          document.removeEventListener("mouseup", mouse_up);
          circle.remove();
          i_line.remove();
        }

        document.addEventListener("mousemove", mouse_move);
        document.addEventListener("mouseup", mouse_up);
      }

      function pin_in(t){
        flag_2 = true;

        t_2 = t;
        
        block_1 = blocks.find(itm => itm.id == t_1.closest(".movable").id);
        block_2 = blocks.find(itm => itm.id == t_2.closest(".movable").id);

        t_1_b = block_1.output.find(itm => itm.id == t_1.id);
        t_2_b = block_2.input.find(itm => itm.id == t_2.id);
        
        flag_conn = false;

        block_2.input.forEach(itm_0 => { 
          itm_0.connection.forEach(itm_1 => {
            if (itm_1.to == t_2.id) {
              flag_conn = true;
            }
          })
        });

        if (flag_conn && !flag_1) {
          delete_connection([t_2.id], false);

          svg.querySelector("line[conn_but~=" + t_2.id + "]").remove();
        }
        if (flag_1){
          if (t_2_b.type != t_1_b.type) return;

          if (flag_conn){
            delete_connection([t_2.id], false);
            
            svg.querySelector("line[conn_but~=" + t_2.id + "]").remove();
          }

          if (block_1.id == block_2.id) return;

          t_1_b.connection.push({from: t_1.id, to: t_2.id, from_block: block_1.id, to_block: block_2.id})
          t_2_b.connection.push({from: t_1.id, to: t_2.id, from_block: block_1.id, to_block: block_2.id})
          
          line = document.createElementNS("http://www.w3.org/2000/svg", "line");
          let svgRect = svg.getBoundingClientRect();
          let outRect = t_1.getBoundingClientRect();
          let inRect = t_2.getBoundingClientRect();

          line.setAttribute("x1", outRect.left + outRect.width/2 - svgRect.left);
          line.setAttribute("y1", outRect.top + outRect.height/2 - svgRect.top);
          line.setAttribute("x2", inRect.left + inRect.width/2 - svgRect.left);
          line.setAttribute("y2", inRect.top + inRect.height/2 - svgRect.top);
          line.setAttribute("stroke-width", 2);
          line.setAttribute("stroke", "white");
          line.setAttribute("conn_block", block_1.id + " " + block_2.id);
          line.setAttribute("conn_but", t_1.getAttribute("id") + " " + t_2.getAttribute("id"));

          svg.append(line);

          flag_1 = false;
        }
      }
  </script>
  <!--Передвижение (очевидно)-->
  <script src="scripts/movable.js"></script>


  <div class="side-button-1-wr">
    <label class="side-button-1" for="side-checkbox">
      <div class="side-b side-open">Ξ</div>
    </label>
  </div>  
</body>
</html>